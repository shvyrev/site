<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Demo OKZ</title>

    <!--FONTS-->
    <link href="//fonts.googleapis.com/css?family=Open+Sans:400,300,600,400italic,700,800" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Raleway:300,200,100" rel="stylesheet" type="text/css">

    <!--jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!--Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

    <!--Font Awesome-->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!--Theme-->
    <!--<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.css" rel="stylesheet" integrity="sha384-RpX8okQqCyUNG7PlOYNybyJXYTtGQH+7rIKiVvg1DLg6jahLEk47VvpUyS+E2/uJ" crossorigin="anonymous">-->

    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/slate/bootstrap.min.css" rel="stylesheet" integrity="sha384-RpX8okQqCyUNG7PlOYNybyJXYTtGQH+7rIKiVvg1DLg6jahLEk47VvpUyS+E2/uJ" crossorigin="anonymous">
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" integrity="sha384-pVJelSCJ58Og1XDc2E95RVYHZDPb9AVyXsI8NoVpB2xmtxoZKJePbMfE4mlXw7BJ" crossorigin="anonymous">-->

    <!--Other libraries-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>

</head>
<body>
<div class="container-fluid theme-showcase">
    <div class="col-md-2"></div>
    <div class="col-md-8">
        <h1>Ввод данных о юр. лице.</h1>

        <div class="help-block"></div>

        <label for="inn">ИНН</label>
        <div class="input-group">
            <input type="text" class="form-control" id="inn" value="7724351535">
        </div>

        <div class="help-block"></div>
        <label for="phone-number">Телефонный номер</label>
        <div class="input-group">
            <input type="text" class="form-control" required id="phone-number">
        </div>

        <div class="help-block"></div>
        <label for="email">Email</label>
        <div class="input-group">
            <input type="text" class="form-control" required id="email">
        </div>

        <div class="help-block"></div>
        <button id="captcha-button" type="button" class="btn btn-primary" onclick="sendClick()">Отправить</button>

        <div class="help-block"></div>

        <table class="table hidden" id="company-data">
            <thead>
            <tr>
                <th>Наименование юр. лица</th>
                <th>Ген. директор</th>
                <th>ОГРН</th>
                <th>Юр. адрес</th>
            </tr>
            </thead>
            <tbody>
            <tr>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="col-md-2"></div>


    <div id="captcha-modal" class="modal fade">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Капча</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="captcha-image" src="..." class="rounded mx-auto d-block" alt="Responsive image">
                    <div class="help-block"></div>
                    <label for="captcha-text">Пожалуйста введите текст с картинки</label>
                    <div class="input-group">
                        <input type="text" class="form-control" required id="captcha-text">
                    </div>
                    <div class="help-block"></div>
                </div>
                <div class="modal-footer">
                    <button id="reload-image" type="button" class="btn btn-primary">Обновить</button>
                    <button id="send-captcha" type="button" class="btn btn-secondary" data-dismiss="modal">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <div id="captcha-error-modal" class="modal fade">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ошибка ввода.</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <label for="captcha-text">Пожалуйста попрробуйте еще раз.</label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="reloadPage()">Повторить</button>
                </div>
            </div>
        </div>
    </div>

    <div id = "alert_placeholder"></div>

</div>

<script>

    var host = "https://nalog-ru-crawler.herokuapp.com";
//    var host = "http://localhost:8080";
    var captchaRequest = {};


    function reloadPage() {
        window.location.reload(true);
    }

    window.document.reloadImage = function reloadImage() {
        $("#captcha-image").attr("src", captchaRequest.captchaSource + "&timestamp=" + new Date().getTime());
    };

    function sendClick() {
        var url = host + "/nalogru/" + $("#inn").val();

        console.log("url:" + url);

        $.get(url, function (data) {
            })
            .done(function (e) {

                captchaRequest.id = e.id;
                captchaRequest.captchaSource = e.captchaSource;

                window.document.reloadImage();

                $("#captcha-modal").modal("show");
            })
            .fail(function (e) {
                console.log("fail:", e);
            })
    }

    $('#captcha-modal').on('shown.bs.modal', function () {
        $('#captcha-text').val("");
        $('#captcha-text').focus()
    })

    $("#reload-image").click(function () {
        window.document.reloadImage();
    });

    window.document.companyTable = $("#company-data")

    $("#send-captcha").click(function () {

        console.log(captchaRequest);
        var url = host + "/nalogru/captcha/" + captchaRequest.id + "/" + $("#captcha-text").val();
        $.get(url, function (e) {
            console.log(e);
        })
            .done(function (e) {
                $("#captcha-button").remove();
                console.log(e.rows.length)
                e.rows.forEach(
                    function(item, i, arr) {
                        $("#company-data > tbody:last-child")
                            .append("<tr>" +
                                "<td>" + item.name.toUpperCase()+ "</td>" +
                                "<td>" + "не определен" + "</td>" +
                                "<td>" + item.ogrn + "</td>" +
                                "<td>" + item.adrestext + "</td>" +
                                "</tr>");
                    });
                $("#company-data").removeClass('hidden');
            })
            .fail(function (e) {
                $("#captcha-error-modal").modal("show");
            });

    });

</script>
</body>
</html>