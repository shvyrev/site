<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Demo OKZ</title>

    <!--FONTS-->
    <link href="//fonts.googleapis.com/css?family=Open+Sans:400,300,600,400italic,700,800" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Raleway:300,200,100" rel="stylesheet" type="text/css">

    <!--jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!--Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

    <!--Font Awesome-->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!--Theme-->
    <!--<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.css" rel="stylesheet" integrity="sha384-RpX8okQqCyUNG7PlOYNybyJXYTtGQH+7rIKiVvg1DLg6jahLEk47VvpUyS+E2/uJ" crossorigin="anonymous">-->

    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/slate/bootstrap.min.css" rel="stylesheet" integrity="sha384-RpX8okQqCyUNG7PlOYNybyJXYTtGQH+7rIKiVvg1DLg6jahLEk47VvpUyS+E2/uJ" crossorigin="anonymous">-->
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" integrity="sha384-pVJelSCJ58Og1XDc2E95RVYHZDPb9AVyXsI8NoVpB2xmtxoZKJePbMfE4mlXw7BJ" crossorigin="anonymous">

    <!--Other libraries-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>

</head>
<body>
<div class="container-fluid theme-showcase">
    <div class="col-md-2"></div>
    <div class="col-md-8">
        <h1>Ввод данных о юр. лице.</h1>

        <div class="help-block"></div>

        <label for="inn">ИНН</label>
        <div class="input-group">
            <input type="text" class="form-control" id="inn" value="7724351535">
        </div>

        <div class="help-block"></div>
        <label for="phone-number">Телефонный номер</label>
        <div class="input-group">
            <input type="text" class="form-control" required id="phone-number">
        </div>

        <div class="help-block"></div>
        <label for="email">Email</label>
        <div class="input-group">
            <input type="text" class="form-control" required id="email">
        </div>

        <div class="help-block"></div>
        <button id="captcha-button" type="button" class="btn btn-primary" onclick="sendClick()">Отправить</button>

        <div class="help-block"></div>

        <div id="credit-form" class="hidden">

            <table class="table" id="company-data">
                <thead>
                <tr>
                    <th>Наименование юр. лица</th>
                    <th>Ген. директор</th>
                    <th>ОГРН</th>
                    <th>Юр. адрес</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                </tr>
                </tbody>
            </table>

            <div class="help-block"></div>


            <div class="help-block"></div>
            <label for="summa">Сумма</label>
            <div class="input-group">
                <input type="text" class="form-control" required id="summa">
            </div>

            <div class="help-block"></div>
            <label for="srok">Срок, месяцев</label>
            <div class="input-group">
                <input type="text" class="form-control" required id="srok">
            </div>

            <div class="help-block"></div>
            <label for="zalog">Залог</label>
            <div class="input-group">
                <input type="text" class="form-control" required id="zalog">
            </div>

            <div class="help-block"></div>
            <label for="otrasl">Отрасль</label>
            <div class="input-group">
                <input type="text" class="form-control" required id="otrasl">
            </div>

            <div class="help-block"></div>
            <label for="cel">Цель кредита</label>
            <div class="input-group">
                <input type="text" class="form-control" required id="cel">
            </div>

            <div class="help-block"></div>
            <button id="run-scroll-button" type="button" class="btn btn-primary">Ok</button>

            <div class="help-block"></div>

            <table class="table table-borderless" id="long-table" style="background: none; border: none">
                <tbody>
                <tr>
                </tr>
                </tbody>
            </table>

            <div class="col-md-11"></div>
            <div id="preloader" class="col-md-1" class="hidden">
                <img src="http://www.selloceaapq.es/Images/loading2.gif" width="50px" height="50px">
            </div>

        </div>

    </div>

    <div class="col-md-2"></div>


    <div id="captcha-modal" class="modal fade">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Капча</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="captcha-image" src="..." class="rounded mx-auto d-block" alt="Responsive image">
                    <div class="help-block"></div>
                    <label for="captcha-text">Пожалуйста введите текст с картинки</label>
                    <div class="input-group">
                        <input type="text" class="form-control" required id="captcha-text">
                    </div>
                    <div class="help-block"></div>
                </div>
                <div class="modal-footer">
                    <button id="reload-image" type="button" class="btn btn-default">Обновить</button>
                    <button id="send-captcha" type="button" class="btn btn-primary" data-dismiss="modal">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <div id="captcha-error-modal" class="modal fade">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ошибка ввода.</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <label for="captcha-text">Пожалуйста попрробуйте еще раз.</label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="reloadPage()">Повторить</button>
                </div>
            </div>
        </div>
    </div>

    <div id = "alert_placeholder"></div>

</div>

<script>

    var host = "https://nalog-ru-crawler.herokuapp.com";
//    var host = "http://localhost:8080";
    var captchaRequest = {};


    function reloadPage() {
        window.location.reload(true);
    }

    window.document.reloadImage = function reloadImage() {
        $("#captcha-image").attr("src", captchaRequest.captchaSource + "&timestamp=" + new Date().getTime());
    };

    function sendClick() {
        var url = host + "/nalogru/" + $("#inn").val();

        $.get(url, function (data) {
            })
            .done(function (e) {

                captchaRequest.id = e.id;
                captchaRequest.captchaSource = e.captchaSource;

                window.document.reloadImage();

                $("#captcha-modal").modal("show");
            })
            .fail(function (e) {
                $("#captcha-error-modal").modal("show");

//                console.log("fail:", e);
            })
    }

    $('#captcha-modal').on('shown.bs.modal', function () {
        $('#captcha-text').val("");
        $('#captcha-text').focus()
    })

    $("#reload-image").click(function () {
        window.document.reloadImage();
    });

    window.document.companyTable = $("#company-data")

    $("#send-captcha").click(function () {

//        console.log(captchaRequest);
        var url = host + "/nalogru/captcha/" + captchaRequest.id + "/" + $("#captcha-text").val();
        $.get(url, function (e) {
            console.log(e);
        })
            .done(function (e) {
                $("#captcha-button").remove();
//                console.log(e.rows.length)
                e.rows.forEach(
                    function(item, i, arr) {
                        $("#company-data > tbody:last-child")
                            .append("<tr>" +
                                "<td>" + item.name.toUpperCase()+ "</td>" +
                                "<td>" + "не определен" + "</td>" +
                                "<td>" + item.ogrn + "</td>" +
                                "<td>" + item.adrestext + "</td>" +
                                "</tr>");
                    });
                $("#credit-form").removeClass('hidden');
//                $("#company-data").removeClass('hidden');
            })
            .fail(function (e) {
                $("#captcha-error-modal").modal("show");
            });
    });

    $("#run-scroll-button").click(function () {

        $("#run-scroll-button").attr("disabled","disabled");

        startRunning();

    });

    function startRunning() {

        $("#preloader").removeClass("hidden");

        var array = [
            "<h2>СТОП-ФАКТОРНЫЙ АНАЛИЗ</h2>","",
            "<h3>Деловая репутация компании</h3>","",
            "<h4>&nbsp;1.1 Срок работы компании менее 12 мес</h4>","<h4>OK</h4>",
            "<h4>1.2 Клиент в стадии процедуры банкротства</h4>","<h4>OK</h4>",
            "<h4>1.3 Клиент имеет ограничения по счету со стороны УФНС</h4>","<h4>OK</h4>",
            "<h4>1.4 Клиент не предоставляет налоговую отчетность более года</h4>","<h4>OK</h4>",
            "<h4>1.5 Клиент в реестре недобросовестных поставщиков</h4>","<h4>OK</h4>",
            "<h4>1.6 Просроченной задолженность по платежам в бюджеты</h4>","<h4>OK</h4>",
            "<h4>1.7 Исполнительное производство превышает 100 тыс. руб.</h4>","<h4>OK</h4>",
            "<h4>1.8 Сумма исков к клиенту превышает 200 тысяч руб.</h4>","<h4>OK</h4>",
            "<h4>1.9 Отсутствие у Клиента действующей лицензии</h4>","<h4>OK</h4>",
            "<h4>1.10 ОКВЭД: ценные бумаги, ломбарды, кредитные организации</h4>","<h4>OK</h4>",
            "<h3>2. Деловая репутация генерального директора</h3>","",
            "<h4>2.1 Генеральный директор в реестре массовых руководителей</h4>","<h4>OK</h4>",
            "<h4>2.2 Судимость</h4>","<h4>OK</h4>",
            "<h4>2.3 Кредитная история</h4>","<h4>OK</h4>",
            "<h4>2.4 Исполнительное производство превышает 100 тыс. руб.</h4>","<h4>OK</h4>",
            "<h4>2.5 Генеральный директор - банкрот</h4>","<h4>OK</h4>",
            "<h4>2.6 Генеральный директор дисквалифицированное лицо</h4>","<h4>OK</h4>",
            "<h3>3. Деловая репутация бенефициара</h3>","",
            "<h4>3.1 Бенефициарв реестре массовых руководителей и учредитей</h4>","<h4>OK</h4>",
            "<h4>3.2 Судимость</h4>","<h4>OK</h4>",
            "<h4>3.3 Кредитная история</h4>","<h4>OK</h4>",
            "<h4>3.4 Исполнительное производство превышает 100 тыс. руб.</h4>","<h4>OK</h4>",
            "<h4>3.5 Бенефициар - банкрот</h4>","<h4>OK</h4>",
            "<h3 class=\"display-4 text-info\">Критических стоп-факторов: не обнаружено.<br>Некритических стоп-факторов: не обнаружено</h3>","",
            "<h2>РАСЧЕТ ЛИМИТА</h2>","",
            "<h3>4. Анализ р/с за 12 мес</h3>","",
            "<h4>4.1 Очистка по р/с по кредитовому обороту</h4>","<h4>OK</h4>",
            "<h4>4.2 Анализ на ключевые слова: возврат, кредит, займ</h4>","<h4>OK</h4>",
            "<h4>4.3 Поступления от аффилированных компаний</h4>","<h4>OK</h4>",
            "<h4>4.4 Анализ кредитового оборота</h4>","<h4>OK</h4>",
            "<h3>5. Проверка 5 крупнейших контрагентов на стопы</h3>","",
            "<h4>5.1 Контрагент 1</h4>","<h4>OK</h4>",
            "<h4>5.1 Контрагент 2</h4>","<h4>OK</h4>",
            "<h4>5.1 Контрагент 3</h4>","<h4>OK</h4>",
            "<h4>5.1 Контрагент 4</h4>","<h4>OK</h4>",
            "<h4>5.1 Контрагент 5</h4>","<h4>OK</h4>",
            "<h3>6. Расчет лимита</h3>","",
            "<h4>6.1 Посчитать долговую нагрузку</h4>","<h4>OK</h4>",
            "<h4>6.2 Найти процентные выплаты</h4>","<h4>OK</h4>",
            "<h4>6.3 Сложить все выплаты по дебетовому обороту</h4>","<h4>OK</h4>",
            "<h4>6.4 50% от кредитового оборота</h4>","<h4>OK</h4>",
            "<h3 class=\"display-4 text-info\">Расчетный лимит: 2 000 000 рублей</h3>","",
            "<h2>РАСЧЕТ КЛАССА РИСКА (АНАЛИЗ ФИНАНСОВОГО ПОЛОЖЕНИЯ)</h2>","",
            "<h3>7. Анализ платежеспособности и платежной дисциплины</h3>","",
            "<h4>7.1 Наличие просрочек по налоговым и кредитным платежам</h4>","<h4>OK</h4>",
            "<h3 class=\"display-4 text-info\">Класс риска: B.<br>Рекомендованная процентная ставка: 25-27% годовых</h3>",""
        ];

        var count = 0;

        window.document.rollingInterval = setInterval(function () {
            $("#long-table > tbody:last-child")
                .append(
                    "<tr>" +
                    "<td>" + array[count]+ "</td>" +
                    "<td>" + array[count + 1] + "</td>" +
                    "</tr>");
            count+=2;

            $("html, body").animate({ scrollTop: $(document).height() }, "slow");

            if(count >= array.length){
                $("#preloader").remove();
                clearInterval(window.document.rollingInterval);
            }
        }, 500);

        console.log("here");

    }

</script>
</body>
</html>